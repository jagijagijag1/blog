<!doctype html><html lang=en><head><meta charset=utf-8><title>Togglの記録をServerless + Pixelaで草化 - jagijagijag1 notes</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.75.1"><meta itemprop=name content="Togglの記録をServerless + Pixelaで草化"><meta itemprop=description content="作業時間などの時間管理ツールとしてTogglがある  いつ，どの作業をしたかを記録 各作業をプロジェクトやタグで分類可能 Toggl Reportsで可視化も提供されており，特定の作業をどれくらい継続しているか，どのくらい時間をかけているかを見れる でもとりあえず草化したい！   ToggleはAPIを提供しているので比較的用意にデータ抽出可能  画像認識とかいらない！    作ったもの  1日1回，前日に特定プロジェクトにかけた時間をTogglから抽出し，Pixelaに記録  結果  自分の勉強時間を草化できた  環境  MacOS Mojave Go 1.11.1 Serverless Framework 1.32.0  つまづきメモ  しょぼい内容だが備忘録として  Lambdaにて時間を扱う場合の注意  CloudWatch Eventsをcron式で時間指定する場合，UTCで指定すること  e.g. JSTで毎日午前1時に実行したい→UTCで午後4時(-9時間)を指定する cron( 0 16 * * ? * )   Lambda関数で日時を取得する場合(e.g. Goでのtime.Now())，標準ではUTCで取得する 日本時間を使いたい場合はLambda関数の環境変数でタイムゾーンを指定すること  e.g. 変数TZ, 値Asia/Tokyo    Toggl APIの使い方  TogglのAPIを利用したい場合，リクエストにAPIトークンを含める  APIトークンはProfileから取得可能: https://support."><meta itemprop=datePublished content="2018-11-10T10:52:38+09:00"><meta itemprop=dateModified content="2018-11-10T10:52:38+09:00"><meta itemprop=wordCount content="498"><meta itemprop=keywords content="Go,serverless,pixela,"><meta property="og:title" content="Togglの記録をServerless + Pixelaで草化"><meta property="og:description" content="作業時間などの時間管理ツールとしてTogglがある  いつ，どの作業をしたかを記録 各作業をプロジェクトやタグで分類可能 Toggl Reportsで可視化も提供されており，特定の作業をどれくらい継続しているか，どのくらい時間をかけているかを見れる でもとりあえず草化したい！   ToggleはAPIを提供しているので比較的用意にデータ抽出可能  画像認識とかいらない！    作ったもの  1日1回，前日に特定プロジェクトにかけた時間をTogglから抽出し，Pixelaに記録  結果  自分の勉強時間を草化できた  環境  MacOS Mojave Go 1.11.1 Serverless Framework 1.32.0  つまづきメモ  しょぼい内容だが備忘録として  Lambdaにて時間を扱う場合の注意  CloudWatch Eventsをcron式で時間指定する場合，UTCで指定すること  e.g. JSTで毎日午前1時に実行したい→UTCで午後4時(-9時間)を指定する cron( 0 16 * * ? * )   Lambda関数で日時を取得する場合(e.g. Goでのtime.Now())，標準ではUTCで取得する 日本時間を使いたい場合はLambda関数の環境変数でタイムゾーンを指定すること  e.g. 変数TZ, 値Asia/Tokyo    Toggl APIの使い方  TogglのAPIを利用したい場合，リクエストにAPIトークンを含める  APIトークンはProfileから取得可能: https://support."><meta property="og:type" content="article"><meta property="og:url" content="http://jagijagijag1.github.io/blog/posts/2018_11_10/"><meta property="article:published_time" content="2018-11-10T10:52:38+09:00"><meta property="article:modified_time" content="2018-11-10T10:52:38+09:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Togglの記録をServerless + Pixelaで草化"><meta name=twitter:description content="作業時間などの時間管理ツールとしてTogglがある  いつ，どの作業をしたかを記録 各作業をプロジェクトやタグで分類可能 Toggl Reportsで可視化も提供されており，特定の作業をどれくらい継続しているか，どのくらい時間をかけているかを見れる でもとりあえず草化したい！   ToggleはAPIを提供しているので比較的用意にデータ抽出可能  画像認識とかいらない！    作ったもの  1日1回，前日に特定プロジェクトにかけた時間をTogglから抽出し，Pixelaに記録  結果  自分の勉強時間を草化できた  環境  MacOS Mojave Go 1.11.1 Serverless Framework 1.32.0  つまづきメモ  しょぼい内容だが備忘録として  Lambdaにて時間を扱う場合の注意  CloudWatch Eventsをcron式で時間指定する場合，UTCで指定すること  e.g. JSTで毎日午前1時に実行したい→UTCで午後4時(-9時間)を指定する cron( 0 16 * * ? * )   Lambda関数で日時を取得する場合(e.g. Goでのtime.Now())，標準ではUTCで取得する 日本時間を使いたい場合はLambda関数の環境変数でタイムゾーンを指定すること  e.g. 変数TZ, 値Asia/Tokyo    Toggl APIの使い方  TogglのAPIを利用したい場合，リクエストにAPIトークンを含める  APIトークンはProfileから取得可能: https://support."><meta name=twitter:site content="@jagijagijag1"><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.3/styles/hybrid.min.css><link rel=stylesheet href=/blog/css/bundle.min.c88daf8304a2b3db8d35fd49937812c9c8813008ae49e5cbe28190db1081b863.css integrity="sha256-yI2vgwSis9uNNf1Jk3gSyciBMAiuSeXL4oGQ2xCBuGM="><link rel=stylesheet href=/blog/css/add-on.css><link href=https://unpkg.com/applause-button/dist/applause-button.css rel=stylesheet type=text/css><script src=https://unpkg.com/applause-button/dist/applause-button.js></script></head><body><header id=site-header><nav id=site-nav><h1 class=nav-title><a href=/blog/ class=nav>Togglの記録をServerless + Pixelaで草化</a></h1><menu id=site-nav-menu class="flyout-menu menu"><a href=/blog/ class="nav link"><i class="fa fa-home"></i>Home</a>
<a href=/blog/posts/ class="nav link"><i class="far fa-newspaper"></i>Articles</a>
<a href=/blog/categories/ class="nav link"><i class="fas fa-sitemap"></i>Categories</a>
<a href=/blog/tags/ class="nav link"><i class="fas fa-tags"></i>Tags</a>
<a href=#share-menu class="nav link share-toggle"><i class="fas fa-share-alt">&nbsp;</i>Share</a>
<a href=#search-input class="nav link search-toggle"><i class="fas fa-search">&nbsp;</i>Search</a></menu>
<a href=#search-input class="nav search-toggle"><i class="fas fa-search fa-2x">&nbsp;</i></a>
<a href=#share-menu class="nav share-toggle"><i class="fas fa-share-alt fa-2x">&nbsp;</i></a>
<a href=#site-nav class="nav nav-toggle"><i class="fas fa-bars fa-2x"></i></a></nav><menu id=search class=menu><input id=search-input class="search-input menu"></input><div id=search-results class="search-results menu"></div></menu><menu id=share-menu class="flyout-menu menu"><h1>Share Post</h1><a href="//twitter.com/share?text=Toggl%e3%81%ae%e8%a8%98%e9%8c%b2%e3%82%92Serverless%20%2b%20Pixela%e3%81%a7%e8%8d%89%e5%8c%96&url=http%3a%2f%2fjagijagijag1.github.io%2fblog%2fposts%2f2018_11_10%2f" target=_blank rel=noopener class="nav share-btn twitter"><p>Twitter</p></a></menu></header><div id=wrapper><section id=site-intro><a href=/blog/><img src=http://jagijagijag1.github.io/blog/images/icon.png class=circle width=100 alt="my icon"></a><header><h1>jagijagijag1 tech note</h1></header><main></main><footer><ul class=socnet-icons><li><a href=//github.com/jagijagijag1 target=_blank rel=noopener title=GitHub class="fab fa-github"></a></li><li><a href=//twitter.com/jagijagijag1 target=_blank rel=noopener title=Twitter class="fab fa-twitter"></a></li><li><a href=//pixe.la/@jagijagijag1 target=_blank rel=noopener title=Pixela class="fas fa-th"></a></li></ul></footer></section><main id=site-main><article class=post><header><div class=title><h2><a href=/blog/posts/2018_11_10/>Togglの記録をServerless + Pixelaで草化</a></h2></div><div class=meta><time datetime="2018-11-10 10:52:38 +0900 +0900">November 10, 2018</time><p>jagijagijag1</p></div></header><div id=socnet-share><div><applause-button color=firebrick url=http://jagijagijag1.github.io/blog/posts/2018_11_10/ multiclap=true style="width: 55px; height: 55px; margin-right: 15px;"></div><a href="//twitter.com/share?text=Toggl%e3%81%ae%e8%a8%98%e9%8c%b2%e3%82%92Serverless%20%2b%20Pixela%e3%81%a7%e8%8d%89%e5%8c%96&url=http%3a%2f%2fjagijagijag1.github.io%2fblog%2fposts%2f2018_11_10%2f" target=_blank rel=noopener class="nav share-btn twitter"><p>Twitter</p></a></div><div class=content><ul><li>作業時間などの時間管理ツールとして<a href=https://toggl.com/>Toggl</a>がある<ul><li>いつ，どの作業をしたかを記録</li><li>各作業をプロジェクトやタグで分類可能</li><li><a href=https://toggl.com/time-reports/>Toggl Reports</a>で可視化も提供されており，特定の作業をどれくらい継続しているか，どのくらい時間をかけているかを見れる</li><li><strong>でもとりあえず草化したい！</strong></li></ul></li><li>Toggleは<a href=https://github.com/toggl/toggl_api_docs/blob/master/toggl_api.md>API</a>を提供しているので比較的用意にデータ抽出可能<ul><li><a href=https://qiita.com/jagijagijag1/items/b0ddae1b93922bdd8587>画像認識</a>とかいらない！</li></ul></li></ul><h2 id=作ったもの>作ったもの</h2><ul><li>1日1回，前日に特定プロジェクトにかけた時間をTogglから抽出し，Pixelaに記録</li></ul><p><img src=/blog/posts/2018_11_10/c45faff3cdd755774dd692a645d514be.jpg alt=undefined.jpg></p><h3 id=結果>結果</h3><ul><li>自分の勉強時間を草化できた</li></ul><p><img src=/blog/posts/2018_11_10/2fed5453892fbe25102a4afe8597e666.jpg alt=undefined.jpg></p><h3 id=環境>環境</h3><ul><li>MacOS Mojave</li><li>Go 1.11.1</li><li>Serverless Framework 1.32.0</li></ul><h2 id=つまづきメモ>つまづきメモ</h2><ul><li>しょぼい内容だが備忘録として</li></ul><h3 id=lambdaにて時間を扱う場合の注意>Lambdaにて時間を扱う場合の注意</h3><ul><li>CloudWatch Eventsをcron式で時間指定する場合，UTCで指定すること<ul><li>e.g. JSTで毎日午前1時に実行したい→UTCで午後4時(-9時間)を指定する <code>cron( 0 16 * * ? * )</code></li></ul></li><li>Lambda関数で日時を取得する場合(e.g. Goでの<code>time.Now()</code>)，標準ではUTCで取得する</li><li>日本時間を使いたい場合はLambda関数の環境変数でタイムゾーンを指定すること<ul><li>e.g. 変数<code>TZ</code>, 値<code>Asia/Tokyo</code></li></ul></li></ul><h3 id=toggl-apiの使い方>Toggl APIの使い方</h3><ul><li>TogglのAPIを利用したい場合，リクエストにAPIトークンを含める<ul><li>APIトークンはProfileから取得可能: <a href=https://support.toggl.com/my-profile/>https://support.toggl.com/my-profile/</a></li></ul></li><li>今回は特定期間の記録を全取得し，特定プロジェクトの記録のみ加算していき合計時間を取得</li><li>特定期間の記録を取得するAPIは以下<ul><li><code>GET https://www.toggl.com/api/v8/time_entries?start_date=XXX&end_date=XXX</code></li><li>日時はISO 8601形式</li></ul></li><li>今回はGoのwrapperである<a href=https://github.com/dougEfresh/gtoggl>dougEfresh/gtoggl</a>を利用<ul><li>READMEの記載内容だとうまく行かず</li></ul></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;github.com/dougEfresh/gtoggl&#34;</span>
<span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;github.com/dougEfresh/gtoggl-api/gtproject&#34;</span>

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
  <span style=color:#75715e>// HTTP client作成
</span><span style=color:#75715e></span>  <span style=color:#a6e22e>thc</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gthttp</span>.<span style=color:#a6e22e>NewClient</span>(<span style=color:#e6db74>&#34;your-api-token&#34;</span>)
  <span style=color:#f92672>...</span>
  <span style=color:#75715e>// Togglの記録(time entry)取得用クライアント作成
</span><span style=color:#75715e></span>  <span style=color:#a6e22e>tec</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gttimeentry</span>.<span style=color:#a6e22e>NewClient</span>(<span style=color:#a6e22e>thc</span>)
  <span style=color:#75715e>// 特定期間の記録を取得
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>entries</span>, <span style=color:#a6e22e>eerr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tec</span>.<span style=color:#a6e22e>GetRange</span>(<span style=color:#a6e22e>start_date</span>, <span style=color:#a6e22e>end_date</span>)
}
</code></pre></div><h2 id=開発詳細>開発詳細</h2><ul><li>作ったものは<a href=https://github.com/jagijagijag1/toggl2pixela>GitHub - jagijagijag1/toggl2pixela</a>で公開</li></ul><h3 id=serverless-framework--goで開始>Serverless framework + Goで開始</h3><ul><li><code>$GOHOME/src</code>配下で作業</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ serverless create -t aws-go-dep -p &lt;project-name&gt;
</code></pre></div><ul><li>東京リージョンにデプロイしたいので<code>serverless.yml</code>に<code>region</code>を追記</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml:serverless.yml data-lang=yaml:serverless.yml><span style=color:#f92672>provider</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>aws</span>
  <span style=color:#f92672>runtime</span>: <span style=color:#ae81ff>go1.x</span>
  <span style=color:#f92672>region</span>: <span style=color:#ae81ff>ap-northeast-1</span>
</code></pre></div><ul><li>以下でひとまずデプロイテスト可能</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ cd &lt;project-name&gt;
$ make
$ sls deploy
</code></pre></div><h3 id=新規関数を作成>新規関数を作成</h3><ul><li>関数を新規作成<ul><li>自動生成された関数は不要なので削除</li><li><code>toggl2pixela</code>フォルダを作成し，<code>main.go</code>を作成</li><li><code>Makefile</code>の<code>build:</code>に以下を追記</li></ul></li></ul><pre><code class=language-make:Makefile data-lang=make:Makefile>	env GOOS=linux go build -ldflags=&quot;-s -w&quot; -o bin/toggl2pixela toggl2pixela/main.go
</code></pre><h3 id=serverlessymlの修正><code>serverless.yml</code>の修正</h3><ul><li><code>serverless.yml</code>の主な修正・追記点は以下<ul><li>新規作成した関数定義の追記 （+自動生成された関数定義の削除)</li><li><code>events</code>下に<code>schecule: ***</code>を書くことで定期実行を定義 (下記では毎日午前1時に実行，上述の通りcron式の時間はUTC指定なので注意)</li><li>Lambda関数でJSTで日時取得したいので，環境変数<code>TZ</code>, 値<code>Asia/Tokyo</code>を指定</li><li>Lambda関数の環境変数(<code>environment</code>)にTogglのAPIキー/対象プロジェクトID，Pixelaのユーザ/トークン/グラフ情報を与える</li></ul></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml:serverless.yml data-lang=yaml:serverless.yml><span style=color:#f92672>service</span>: <span style=color:#ae81ff>toggl2pixela</span>

<span style=color:#f92672>frameworkVersion</span>: <span style=color:#e6db74>&#34;&gt;=1.28.0 &lt;2.0.0&#34;</span>

<span style=color:#f92672>provider</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>aws</span>
  <span style=color:#f92672>runtime</span>: <span style=color:#ae81ff>go1.x</span>
  <span style=color:#f92672>region</span>: <span style=color:#ae81ff>ap-northeast-1</span>

<span style=color:#f92672>package</span>:
 <span style=color:#f92672>exclude</span>:
   - <span style=color:#ae81ff>./**</span>
 <span style=color:#f92672>include</span>:
   - <span style=color:#ae81ff>./bin/**</span>

<span style=color:#f92672>functions</span>:
  <span style=color:#f92672>toggl2pixela</span>:
    <span style=color:#f92672>handler</span>: <span style=color:#ae81ff>bin/toggl2pixela</span>
    <span style=color:#f92672>events</span>:
      - <span style=color:#f92672>schedule</span>: <span style=color:#ae81ff>cron(0 16 * * ? *)</span>
    <span style=color:#75715e># you need to fill the followings with your own</span>
    <span style=color:#f92672>environment</span>:
      <span style=color:#f92672>TZ</span>: <span style=color:#ae81ff>Asia/Tokyo</span>
      <span style=color:#f92672>TOGGL_API_TOKEN</span>: <span style=color:#ae81ff>&lt;your-api-token&gt;</span>
      <span style=color:#f92672>TOGGL_PROJECT_ID</span>: <span style=color:#ae81ff>&lt;target-project-id&gt; </span>
      <span style=color:#f92672>PIXELA_USER</span>: <span style=color:#ae81ff>&lt;user-id&gt;</span>
      <span style=color:#f92672>PIXELA_TOKEN</span>: <span style=color:#ae81ff>&lt;your-token&gt;</span>
      <span style=color:#f92672>PIXELA_GRAPH</span>: <span style=color:#ae81ff>&lt;your-graph-id-1&gt;</span>
    <span style=color:#f92672>timeout</span>: <span style=color:#ae81ff>10</span>
</code></pre></div><h3 id=関数本体を作成>関数本体を作成</h3><ul><li>素直に実装しただけなので，特記事項なし…<ul><li>データ元のToggl，データ投入先のPixelaの情報は環境変数(<code>TOGGL_API_TOKEN, TOGGL_PROJECT_ID, PIXELA_USER, PIXELA_TOKEN, PIXELA_GRAPH</code>)から取得</li><li>GoでのToggl操作には<a href=https://github.com/dougEfresh/gtoggl>dougEfresh/gtoggl</a>を利用<ul><li>利用方法は上述</li></ul></li><li>GoでのPixela操作には<a href=https://github.com/gainings/pixela-go-client>gainings/pixela-go-client</a>を利用</li></ul></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go:toggl2pixela/main.go data-lang=go:toggl2pixela/main.go><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#f92672>import</span> (
	<span style=color:#e6db74>&#34;context&#34;</span>
	<span style=color:#e6db74>&#34;errors&#34;</span>
	<span style=color:#e6db74>&#34;fmt&#34;</span>
	<span style=color:#e6db74>&#34;os&#34;</span>
	<span style=color:#e6db74>&#34;strconv&#34;</span>
	<span style=color:#e6db74>&#34;time&#34;</span>

	<span style=color:#e6db74>&#34;github.com/aws/aws-lambda-go/lambda&#34;</span>
	<span style=color:#e6db74>&#34;github.com/dougEfresh/gtoggl-api/gthttp&#34;</span>
	<span style=color:#e6db74>&#34;github.com/dougEfresh/gtoggl-api/gttimentry&#34;</span>
	<span style=color:#a6e22e>pixela</span> <span style=color:#e6db74>&#34;github.com/gainings/pixela-go-client&#34;</span>
)

<span style=color:#75715e>// Handler is our lambda handler invoked by the `lambda.Start` function call
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Handler</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
	<span style=color:#75715e>// extract env var
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>apiToken</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;TOGGL_API_TOKEN&#34;</span>)
	<span style=color:#a6e22e>pjID</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>ParseUint</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;TOGGL_PROJECT_ID&#34;</span>), <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>64</span>)
	<span style=color:#a6e22e>user</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;PIXELA_USER&#34;</span>)
	<span style=color:#a6e22e>token</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;PIXELA_TOKEN&#34;</span>)
	<span style=color:#a6e22e>graph</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;PIXELA_GRAPH&#34;</span>)

	<span style=color:#75715e>// extract data from toggl
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>date</span>, <span style=color:#a6e22e>quantity</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getDateAndTimeFromToggl</span>(<span style=color:#a6e22e>apiToken</span>, <span style=color:#a6e22e>pjID</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>date</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;-1&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>quantity</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;-1&#34;</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;Error in accessing toggl&#34;</span>)
	}
	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;date: %s, quantity: %s\n&#34;</span>, <span style=color:#a6e22e>date</span>, <span style=color:#a6e22e>quantity</span>)

	<span style=color:#75715e>// record pixel
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>perr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>recordPixel</span>(<span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>token</span>, <span style=color:#a6e22e>graph</span>, <span style=color:#a6e22e>date</span>, <span style=color:#a6e22e>quantity</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>perr</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;Error in accessing pixela&#34;</span>)
	}

	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getDateAndTimeFromToggl</span>(<span style=color:#a6e22e>apiToken</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>pjID</span> <span style=color:#66d9ef>uint64</span>) (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>string</span>) {
	<span style=color:#75715e>// create toggl client
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>thc</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gthttp</span>.<span style=color:#a6e22e>NewClient</span>(<span style=color:#a6e22e>apiToken</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;-1&#34;</span>, <span style=color:#e6db74>&#34;-1&#34;</span>
	}

	<span style=color:#75715e>// set time range to be analyzed
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>y</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>AddDate</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
	<span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Date</span>(<span style=color:#a6e22e>y</span>.<span style=color:#a6e22e>Year</span>(), <span style=color:#a6e22e>y</span>.<span style=color:#a6e22e>Month</span>(), <span style=color:#a6e22e>y</span>.<span style=color:#a6e22e>Day</span>(), <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Local</span>)
	<span style=color:#a6e22e>e</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Date</span>(<span style=color:#a6e22e>y</span>.<span style=color:#a6e22e>Year</span>(), <span style=color:#a6e22e>y</span>.<span style=color:#a6e22e>Month</span>(), <span style=color:#a6e22e>y</span>.<span style=color:#a6e22e>Day</span>(), <span style=color:#ae81ff>23</span>, <span style=color:#ae81ff>59</span>, <span style=color:#ae81ff>59</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Local</span>)
	<span style=color:#a6e22e>date</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>y</span>.<span style=color:#a6e22e>Format</span>(<span style=color:#e6db74>&#34;20060102&#34;</span>)

	<span style=color:#75715e>// get time entries
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>total</span> <span style=color:#f92672>:=</span> int64(<span style=color:#ae81ff>0</span>)
	<span style=color:#a6e22e>tec</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gttimeentry</span>.<span style=color:#a6e22e>NewClient</span>(<span style=color:#a6e22e>thc</span>)
	<span style=color:#a6e22e>entries</span>, <span style=color:#a6e22e>eerr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tec</span>.<span style=color:#a6e22e>GetRange</span>(<span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>e</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>eerr</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>eerr</span>)
		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;-1&#34;</span>, <span style=color:#e6db74>&#34;-1&#34;</span>
	}

	<span style=color:#75715e>// sum durations with project pjID
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>e</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>entries</span> {
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Pid</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>pjID</span> {
			<span style=color:#a6e22e>total</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Duration</span>
		}
	}
	<span style=color:#a6e22e>totalMin</span> <span style=color:#f92672>:=</span> float64(<span style=color:#a6e22e>total</span>) <span style=color:#f92672>/</span> <span style=color:#ae81ff>60</span>
	<span style=color:#a6e22e>quantity</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>FormatFloat</span>(<span style=color:#a6e22e>totalMin</span>, <span style=color:#e6db74>&#39;f&#39;</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>64</span>)

	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>date</span>, <span style=color:#a6e22e>quantity</span>
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>recordPixel</span>(<span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>token</span>, <span style=color:#a6e22e>graph</span>, <span style=color:#a6e22e>date</span>, <span style=color:#a6e22e>quantity</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
	<span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pixela</span>.<span style=color:#a6e22e>NewClient</span>(<span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>token</span>)

	<span style=color:#75715e>// try to record
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>RegisterPixel</span>(<span style=color:#a6e22e>graph</span>, <span style=color:#a6e22e>date</span>, <span style=color:#a6e22e>quantity</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;recorded&#34;</span>)
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
	}

	<span style=color:#75715e>// if fail, try to update
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>UpdatePixelQuantity</span>(<span style=color:#a6e22e>graph</span>, <span style=color:#a6e22e>date</span>, <span style=color:#a6e22e>quantity</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;updated&#34;</span>)
	}

	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
	<span style=color:#a6e22e>lambda</span>.<span style=color:#a6e22e>Start</span>(<span style=color:#a6e22e>Handler</span>)
}
</code></pre></div></div><footer><div class=stats><ul class=categories><li><a class=article-terms-link href=/blog/categories/dev-note/>dev note</a></li></ul><ul class=tags><li><a class=article-terms-link href=/blog/tags/go/>Go</a></li><li><a class=article-terms-link href=/blog/tags/serverless/>serverless</a></li><li><a class=article-terms-link href=/blog/tags/pixela/>pixela</a></li></ul></div></footer></article><article class=post><div><h2 id=say-something>Say Something</h2><form id=comment-form class=new-comment method=post><h3 class="reply-notice hidden"><span class=reply-name></span></h3><input type=hidden name=options[entryId] value=8b2d7f2c0831d1414b7a1120f22be7ac>
<input type=hidden name=fields[replyThread]>
<input type=hidden name=fields[replyID]>
<input type=hidden name=fields[replyName]>
<input required name=fields[name] type=text placeholder="Your Name">
<input name=fields[website] type=text placeholder="Your Website">
<input required name=fields[email] type=email placeholder="Your Email">
<textarea required name=fields[body] placeholder="Your Message" rows=10></textarea><div class=submit-notice><strong class="submit-notice-text submit-success hidden">Thanks for your comment! It will be shown on the site once it has been approved.</strong>
<strong class="submit-notice-text submit-failed hidden">Sorry, there was an error with your submission. Please make sure all required fields have been completed and try again.</strong></div><input type=submit value=Submit class=button>
<input type=submit value=Submitted class="hidden button" disabled>
<input type=reset value=Reset class=button></form></div><div><h2>Comments</h2></div></article><div class=pagination><a href=/blog/posts/2018_11_24/ class="button left"><span>serverless framworkで画像認識して関係する映画を推薦するSlack Botを作ったまとめ (No Server November Challenge)</span></a>
<a href=/blog/posts/2018_11_07/ class="button right"><span>CAV 2018でのAWS招待講演のまとめ</span></a></div></main><section id=site-sidebar><section id=recent-posts><header><h1>Recent Posts</h1></header><article class=mini-post><header><h2><a href=/blog/posts/2020_04_30/>bulmaのcolumnを使った際にモバイル表示するとサイドに余白が出る場合の対処</a></h2><time class=published datetime="2020-04-30 23:29:08 +0900 +0900">April 30, 2020</time></header></article><article class=mini-post><header><h2><a href=/blog/posts/2020_01_26/>リングフィットアドベンチャーの運動ログをサーバーレスでPixelaに記録する</a></h2><time class=published datetime="2020-01-26 13:19:58 +0900 +0900">January 26, 2020</time></header></article><article class=mini-post><header><h2><a href=/blog/posts/2019_11_23/>Cloue Run + Puppeteer + Cloud Schedulebr でサーバーレスなクロールを定期実行する</a></h2><time class=published datetime="2019-11-23 10:38:40 +0900 +0900">November 23, 2019</time></header></article><footer><a href=/blog/posts/ class=button>See More</a></footer></section><section id=categories><header><h1><a href=/blog/categories>Categories</a></h1></header><ul><li><a href=/blog/categories/dev-note/>dev-note<span class=count>9</span></a><li><a href=/blog/categories/trouble-note/>trouble-note<span class=count>3</span></a><li><a href=/blog/categories/tech-note/>tech-note<span class=count>1</span></a></li></ul></section><section id=pixela_access_counter><header><h1>Blog PVs</h1></header><div id=svg-load-area style="border:1px solid rgba(161,161,161,.3)"></div><div style=text-align:right>Powered by <a href=https://pixe.la/ target=_blank>Pixela</a></div></section><script src=https://unpkg.com/tippy.js@3/dist/tippy.all.min.js></script><script>document.addEventListener('DOMContentLoaded',function(){$('#svg-load-area').load('https:\/\/pixe.la\/v1\/users\/jagijagijag1\/graphs\/pomodoro?mode=short',function(){tippy('.each-day',{arrow:true});});});</script></section><footer id=site-footer><ul class=socnet-icons><li><a href=//github.com/jagijagijag1 target=_blank rel=noopener title=GitHub class="fab fa-github"></a></li><li><a href=//twitter.com/jagijagijag1 target=_blank rel=noopener title=Twitter class="fab fa-twitter"></a></li><li><a href=//pixe.la/@jagijagijag1 target=_blank rel=noopener title=Pixela class="fas fa-th"></a></li></ul><p class=copyright>© 2020 jagijagijag1 notes<br>Theme: <a href=https://github.com/pacollins/hugo-future-imperfect-slim target=_blank rel=noopener>Hugo Future Imperfect Slim</a><br>A <a href=https://html5up.net/future-imperfect target=_blank rel=noopener>HTML5 UP port</a> | Powered by <a href=https://gohugo.io/ title=0.75.1 target=_blank rel=noopener>Hugo</a></p></footer><a id=back-to-top href=# class="fas fa-arrow-up fa-2x"></a><script src=/blog/js/highlight.js></script><script>hljs.initHighlightingOnLoad();</script><script src=/blog/js/bundle.min.5955090a3253deadcd66071270aa2274dabe15ffc97094cec252d87b6f3f00bf.js integrity="sha256-WVUJCjJT3q3NZgcScKoidNq+Ff/JcJTOwlLYe28/AL8="></script><script src=/blog/js/add-on.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-22200830-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></div></body></html>